<!DOCTYPE html>
<html>

<head>
  <title>{{title}}</title>
  <link rel="shortcut icon" href="#">
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>

  {{!-- Peerjs for video call --}}
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

  {{!--
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" /> --}}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <link href="/dist/css/tabler.min.css?1674944402" rel="stylesheet" />
  <link href="/dist/css/tabler-vendors.min.css?1674944402" rel="stylesheet" />
  <link href="/dist/css/demo.min.css?1674944402" rel="stylesheet" />

  <link href="/dist/css/tabler-flags.min.css?1674944402" rel="stylesheet" />
  <link href="/dist/css/tabler-payments.min.css?1674944402" rel="stylesheet" />

  {{!-- web socket --}}
  <script src="/socket.io/socket.io.js"></script>

  {{!-- comman functions --}}
  <script src="/javascripts/comman.js" defer></script>

  {{!-- toster cdn --}}
  <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css">

  {{!-- notification actions --}}
  <script src="/javascripts/users/notifications.js" defer></script>

  <style>
    .error {
      color: red;
    }

    .liked_menu {
      max-height: 180px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .badge-notification {
      font-size: 10px;
    }

    .notification-menu {
      width: 400px !important;
    }

    #mycirclelogo {
      width: 170px !important;
      height: 70px !important;
    }

    .unSeen {
      background: #f4f1f1;
    }

    a {
      cursor: pointer !important;
      text-decoration: none !important;
    }

    .cursor-pointer {
      cursor: pointer !important;
      text-decoration: none !important;
    }

    .fa-rotate-90 {
      transform: rotate(90deg);
    }

    .fa-rotate-270 {
      transform: rotate(225deg);
    }

    .call-button {
      width: 40px;
      height: 40px;
      position: relative;
      /* Add relative positioning */
      border-radius: 50%;
      background-color: red;
      color: white;
      cursor: pointer;
    }

    .call-button i {
      position: absolute;
      /* Absolute positioning */
      top: 50%;
      /* Vertically center */
      left: 50%;
      /* Horizontally center */
      transform: translate(-50%, -50%);
      /* Center using transform */
      font-size: 20px;
      transition: transform 0.2s;
    }
  </style>
</head>

<body>
  {{> usernavbar}}
  <div class="body">
    {{{body}}}
  </div>
  <script>
    const userId = $("#userId").attr("class");
    window.audio = new Audio("/audio/my-circle-video-call.mp3");
    window.socket = io.connect(window.location.origin, {
      query: {
        "userId": userId
      }
    });

    socket.on("incoming-call", (data) => {
      if ($('#user-list li.selected').data("id") == data.caller) {
        $("#P2P-video-call").attr("data-roomid", data.roomId);
        $("#P2P-video-call").addClass("text-success");
      }
      audio.play();
      $("#caller-details").html(`<div href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                          <span class="avatar me-1 rounded" style="background-image: url(${data.path})"></span>
                          <div class="d-none d-xl-block ps-2">
                              <div>${data.name} is calling ...</div>
                          </div>
                      </div>`)
      $("#incoming-call-modal").modal('show');
      $("#call-accept").attr("data-id", data.caller);
      $("#call-reject").attr("data-id", data.caller);
      $("#call-accept").attr("data-roomid", data.roomId);
      $("#call-reject").attr("data-roomid", data.roomId);
    });

    socket.on("missed-call", () => {
      $("#incoming-call-modal").modal('hide');
      toastr.error(`Missed call !`).delay(2000).fadeOut(1000);
      $("#P2P-video-call").removeAttr("data-roomid");
      $("#P2P-video-call").removeClass("text-success");
    });

    function getNotifyCount() {
      $.ajax({
        type: "get",
        url: `/users/notifications/unSeen`,
        success: function (response) {
          $(".notification-menu").html(response);
          const totalCount = $(".total-notify").data("total");
          if (totalCount > 0) {
            $("#notifications").html(`<span class="badge bg-danger badge-notification badge-pill">${totalCount}</span>`);
          }
          else {
            $("#notifications").html("");
          }
        },
        error: function (error) {
          console.log(error);
        }
      });
      return;
    }
    getNotifyCount();

    socket.emit("getRequestCount", userId)
    socket.on("totalRequests", (RequestCount) => {
      if (RequestCount > 0) {
        $("#requests").html(`<span class="badge bg-danger badge-notification badge-pill">${RequestCount}</span>`);
      }
      else {
        $("#requests").html("");
      }
    });
    socket.on("requestNotify", (RequestCount) => {
      $("#requests").html(`<span class="badge bg-danger badge-notification badge-pill">${RequestCount}</span>`);
    });

    $(document).on('click', '.unSeen', function () {
      const notifyId = $(this).data("notifyid");
      socket.emit("updateNotification", notifyId)
    });

    socket.on("newNotification", (newNotification) => {
      getNotifyCount();
      toastr.info(newNotification).delay(2000).fadeOut(1000);
    });
  </script>

  {{> modals}}
</body>

</html>